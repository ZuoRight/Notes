# 存储器

## 分类

### 按信息的可保存性分类

- 易失性存储器（内存），断电后数据会丢失，比如：RAM、缓存(Cache)
- 非易失性（外存），断电后数据不丢失，比如：ROM，硬盘

### 按存储方式以及读写功能分类

- ROM（Read-Only Memory），只读存储器，通常制造时在脱机情况下由厂家写入信息后，只能随机读取信息，不能写入新信息
- RAM（Random Access Memory），随机访问存储器，也叫主存，是与CPU直接交换数据的内部存储器，可随机读取和写入
- SAM（Sequential Access Memory），只能按存储单元位置顺序地挨个进行存取，比如磁带

### 按存储介质分类

- 磁介质：软盘、软驱(FDD)、机械硬盘(HDD)、磁带等
- 光介质：光驱、光盘（CD->VCD->DVD->BD）
- 半导体介质（闪存技术）：RAM、ROM、固态硬盘(SSD)、U盘等

无论什么介质，都是利用二进制存储数据，也就是说，它们只是以不同的方式模拟0和1。

![20221126014224](http://image.zuoright.com/20221126014224.png)

## ROM

![20221124222816](http://image.zuoright.com/20221124222816.png)

启动固件(Fireware)固化在主板ROM芯片中，主要有早期的BIOS和最新的UEFI两种

引导加载程序(bootloader)是硬件和操作系统之间的接口

### BIOS

Basic I/O System，基本输入输出系统

![20221124223743](http://image.zuoright.com/20221124223743.png)

开机时，BIOS会做开机自检(P.O.S.T)，检测硬件正常后，按照CMOS设置里的顺序搜索引导设备（大概率是硬盘），挨个查看存储设备的前512字节是不是以0x55 0xAA结尾，如果不是，那就跳过找下一个设备；如果是的话，则表示这个磁盘可以启动，然后交给引导程序（Bootloader，比如GRUB2）

> 开机自检（Power On Self Test）会给出提示音，比如哔一声表示正常，长哔三声表示键盘错误，连续短哔可能RAM有问题

![20221124232639](http://image.zuoright.com/20221124232639.png)

CMOS最初是主板上一个单独的芯片，后来被集成到了南侨芯片组，它属于一种RAM，用于存储BIOS的配置（计算机的启动顺序、安装的磁盘驱动器类型、系统时钟的当前日期和时间等），所以也叫RTC(实时时钟)或NVRAM(非易失性RAM)，为避免计算机断电后恢复为默认值，所以CMOS有单独的纽扣电池提供电源（可以充电长达十余年）

![20221124224838](http://image.zuoright.com/20221124224838.png)

### UEFI

Unified Extensible Firmware Interface 统一可扩展固件接口

![20221124225800](http://image.zuoright.com/20221124225800.png)

UEFI不仅仅是BIOS的替换，本质上是一个运行在PC固件之上的微型操作系统，支持更友好的界面，还可以使用鼠标。

BIOS只能识别固定位置的磁盘引导块，而UEFI可以存储在主板的闪存中，也可以在启动时从硬盘或网络共享加载。

UEFI采用GPT分区表的方式后，硬盘容量和分区数目几乎没有上限（目前windows支持最大128个分区）

使用了安全引导，以防止加载未数字签名的驱动程序。在引导过程中，UEFI固件仅在实模式下初始化平台，平台初始化后，UEFI使用基本操作系统为后续启动启用64位保护模式。允许在启动过程中进行远程监视和控制，可防止恶意访问。

## 磁盘

磁盘可分为

- 软盘：唯一优点就是方便携带，如今已被光盘、U盘等取代
- 硬盘：硬盘可分为传统的机械硬盘与固态硬盘

机械硬盘体型和重量较大，需要马达转动和风扇降温，噪音较大，猛烈磕碰有可能会导致盘片损伤数据丢失。

机械硬盘删除数据只是删除了FAT表记录，而数据其实还在，在没有写入或者写入的新数据没有覆盖掉之前的区域，数据是可以被全部或者部分恢复的。

固态硬盘删除数据后，再写入新数据时需要先清除旧数据后才能覆盖，因此虽然固态硬盘读写速度更快，但由于擦写次数有限，所以使用寿命比机械硬盘要低。为了减少写入的时间消耗，一般操作系统会默认在空闲时间自动清理旧数据，也就是说数据删除后基本不太可能找回数据。

### 物理结构

> 这里主要指机械硬盘，虽然固态硬盘在物理结构以及存储介质上与机械硬盘完全不同，但使用原理上基本可相等看待

- 盘面：磁盘是由一叠磁盘面叠加组合构成，每个磁盘面上都会有一个磁头负责读写。
- 磁道(Track)：每个盘面会围绕圆心划分出多个同心圆圈，每个圆圈叫做一个磁道。
- 柱面(Cylinders)：所有盘片上的同一位置的磁道组成的立体叫做一个柱面。
- 扇区(Sector)：每个磁道可划分出多个扇区

### 逻辑结构

- 逻辑扇区
- 簇

随着硬盘容量的不断扩大，为了提高数据记录密度，扇区由最初的512KB变为了4096KB，变大后会带来兼容问题，于是便在物理扇区的基础上划分出512KB的逻辑扇区，由硬盘固件程序负责寻址转换。

> 寻址方式有两种，CHS和LBA，磁盘容量大于8G左右时，只能用LBA寻址

磁盘在使用之前必须先分区并格式化

简单讲分区就是从磁盘上划分出来一大片连续的逻辑扇区，格式化则是对分区范围内扇区的使用进行规划。比如文件数据的储存如何安排、文件属性储存在哪里、目录结构如何存储等等。

格式化程序会将分区里面的所有扇区从头至尾进行分组，划分为固定大小的簇，并按顺序进行编号。每个簇可固定包含一个或多个逻辑扇区（个数总是2的n次方）。格式化以后，分区就会以簇为最小单位进行读写，文件的数据、属性等等信息都要保存到簇里面。

> 磁盘可读写的最小单位是一个逻辑扇区是（即一个簇只包含一个逻辑扇区的情况）

![20221127221555](http://image.zuoright.com/20221127221555.png)

如果分区的起始位置没有对齐到某个物理扇区的边缘，格式化后，所有的簇也将无法对齐到物理扇区的边缘，则会导致读取一个簇需要对应读取两个物理扇区，会造成读写性能的严重下降，于是便有了[4K对齐那些事](https://www.diskgenius.cn/exp/about-4k-alignment.php)

### 分区表（分区方式）

将一个磁盘插入已经含有操作系统的机器上时，操作系统会检索这个磁盘的分区表，并正确认识它的分区结构

- MBR

![20221128013051](http://image.zuoright.com/20221128013051.png)

磁盘的第一个逻辑扇区叫做引导扇区，包含：主引导记录MBR(Master Boot Record) + 分区表 + Magic Bumber(以0x55 0xAA结尾的标志符)

> MBR分区表最大只能管理2.2T的硬盘，最多支持4个分区

每个分区开始部分（占用扇区不定）也都存在引导记录PBR(Partition Boot Record)（上图红色部分），保存着操作系统引导程序配置文件的所在位置

MBR用于查找活动分区，并加载执行活动分区的PBR，PBR查找操作系统中的引导程序

- GPT

GPT/GUID分区表（Globally Unique Identifier Partition Table）全局唯一标识码分区表

![20221128020857](http://image.zuoright.com/20221128020857.png)

属于UEFI规范下的衍生品，可管理的空间和分区数量都没有限制，PMBR部分用于兼容BIOS启动方式

## 启动引导程序

Bootloader 用于从多操作系统的计算机中选择一个系统来启动，或从系统分区中选择特殊的内核配置

Linux发行版中可使用的 Bootloader 有三种

- `GRUB` GRand Unified Bootloader
- `GRUB2` 最新且最常用
- `LILO`

GRUB2，包含`boot.img`(启动代码)和`core.img`(内核镜像)，都包含在MBR代码中

`core.img` 主要包括以下模块

- `diskroot.img`
- `lzma_decompress.img` 解压缩程序
- `kernel.img`

## 管理

```shell
# 查看内存
free [-m]  # 静态，-m 用M为单位显示数据大小
top  # 动态

# 查看磁盘使用量
df -h
```
