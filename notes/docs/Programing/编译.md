# 编译

参考文章

- [编译器的工作过程·阮一峰](https://www.ruanyifeng.com/blog/2014/11/compiler.html)
- [程序的运行过程·极客时间](https://time.geekbang.org/column/article/369457)
- [几行汇编几行C·极客时间](https://time.geekbang.org/column/article/369502)
- [高级语言怎样抽象执行逻辑·极客时间](https://time.geekbang.org/column/article/557209)

CPU只能运行二进制的数据，所以用高级语言编写的源码，需要经过编译(compile)转换为二进制可执行文件，以C语言为例

![20221119003533](http://image.zuoright.com/20221119003533.png)

传统的编译器通常分为三个部分

- 前端(frontEnd)：词法和语法分析，将代码转化为抽象的语法树
- 优化器(Optimizer)：对前段生成的中间代码进行优化
- 后端(backEnd)：将优化的中间代码转换为针对各自平台的机器码

![20221119003207](http://image.zuoright.com/20221119003207.png)

## 支持C语言的编译器

### GCC(GNU Collection) GNU编译器套装

```bash
# 从源码直接生成可执行文件hello.out
gcc hello.c  # 可以指定用哪个C标准来编译，比如：-std=c99

# 通常源代码文件不止一个，所以需要先各自生成目标文件再按依赖关系统一编译为可执行文件
gcc -c hello.c  # 先生成目标文件hello.o
gcc -o hello.out a.o b.o 。# -o指定编译后生成的文件名（可以不加.out后缀）

# 编译目标路径所有文件
gcc -o demo *.o
gcc -o demo *.c

./hello.out  # 运行

# 转成汇编
gcc -S example.c
```

### Clang

Clang 一个基于 LLVM 的编译器前端，支持 C/C++/Objective-C 等语言。其开发目标是替代 GCC。

LLVM(Low Level Virtual Machine) ，是当今炙手可热的编译器基础框架。它从一开始就采用了模块化设计的思想，使得每一个编译阶段都被独立出来，形成了一系列的库。LLVM 使用面向对象的 C++ 语言开发，为编译器开发人员提供了易用而丰富的编程接口和 API。

## 配置

编译器在开始工作之前，需要知道当前的系统环境，比如标准库在哪里、软件的安装位置在哪里、需要安装哪些组件等等。这是因为不同计算机的系统环境不一样，通过指定编译参数，编译器就可以灵活适应环境，编译出各种环境都能运行的机器码。这个确定编译参数的步骤，就叫做配置(configure)，通常由`autoconf`工具生成。

运行configure脚本可生成makefile文件

## 构建

> <https://seisman.github.io/how-to-write-makefile/overview.html>

构建即编译的安排，先编译这个还是先编译那个

Make是C语言最常用的构建工具，需要将构建规则写在makefile中

```makefile
# 定义变量，建议大写，=左右可以有空格
X = registry/zombie-proc:v1

# 目标: 依赖
all: app-test image

app-test: app-test.c
  gcc -o app-test app-test.c  # 命令

image: app-test
  docker build -t ${X} .  # 引用变量，也可也用$(X)

clean: 
  rm -f *.o app-test
  docker rmi ${X}
```

```bash
make -f file  # -f构建指定文件（默认构建makefile）
make image  # 构建指定目标（默认构建第一个目标）
```

## 预处理

> <https://wangdoc.com/clang/preprocessor>

预处理就是加入头文件，替换宏等操作

```c
// 预处理指令以#开头，为了兼容旧版本编译器，后面一般不留空格
// 最常见的预处理指令：#define，用于替换指定的词，每条替换规则称为一个宏（macro）
#define MAX 100  // 这里的MAX就称为一个宏，用于将源码里面的MAX全部替换成100
#undef MAX  // 取消宏
```

## 链接

静态链接，编译时链接，即把外部函数库拷贝到可执行文件中
动态链接，运行时链接，运行时引用依赖库（Linux平台后缀名为`.so`的文件，Windows平台是`.dll`文件，Mac平台是`.dylib`文件）

## objcopy

将一种格式的目标文件转换成另一种格式的目标文件
