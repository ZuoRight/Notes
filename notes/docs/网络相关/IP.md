# IP

## IPv4

IPv4由32位二进制数组成，通常分割成4组，每组8位（以十进制数表示）

![20210725152948](http://image.zuoright.com/20210725152948.png)

IP组成：起始位+网络号+主机号，据此分成5类

![20210726230202](http://image.zuoright.com/20210726230202.png)

ABC类分别预留了三段IP用于不同规模组织作私有使用

D类为组播地址，向这个IP发送消息，组下的主机都可以收到

![20210725153815](http://image.zuoright.com/20210725153815.png)

但通常使用更灵活的CIDR(无类型域间选路)来表示，类似 `x.x.x.x/n` 这种形式，`/n`表示，前n位为固定的网络号，后(32-n)位为主机号

最常用的为`/24`和`/16`，比如最常见也最好理解的私有网络IP段：`192.168.1.x/24`，二进制为：`11000000.10101000.00000001.x`

前24位为网络号，后8位为主机号，网络号部分用1表示，主机号部分用0表示，即子网掩码：`11111111.11111111.11111111.00000000`，转换为10进制为：`255.255.255.0`

然后将二进制的IP和子网掩码按位逻辑与运算，即可得到网络地址：`11000000.10101000.00000001.00000000`，即：`192.168.1.0`

网络地址的主机号部分都置为1，则得到广播地址：`11000000.10101000.00000001.11111111`，即：`192.168.1.255`

- 192.168.1.x/24 IP
- 255.255.255.0 子网掩码
- 192.168.1.0 网络地址
- 192.168.1.255 广播地址（向这个地址发送消息所有主机都可以收到
- 192.168.1.1 第一个地址，通常为默认网关（路由器的一个网口）

除去网络地址和广播地址后，8位主机号可分配2^8=256-2=254个主机IP，还要预留一个给默认网关，知道了这个规则之后，便可以通过主机数倒推子网掩码来规划网络

比如有10台主机，则至少需要10+2+1=13个IP，因为2^4=16 > 13，所以主机号至少要4位，即子网掩码为：11111111.11111111.11111111.11110000，十进制为：255.255.255.240

![20210725151352](http://image.zuoright.com/20210725151352.png)

随着互联网的普及以及个人联网设备数量的增多，可用的大约36.47亿个IPv4地址已经无法满足地球约75亿人口所使用了，于是升级迭代出IPv6协议

## IPv6

IPv6由128位二进制数组成，通常分割成8组，每组16位（以十六进制数表示）

可为地球的每一粒沙子提供唯一IP，但它与IPv4是两个完全不同的协议，需要转换和映射才能数据互通，完全取代IPv4可能还需要很长一段时间。

![20210725152103](http://image.zuoright.com/20210725152103.png)

## 查看IP

```shell
# windows
ipconfig /all

# linux/mac
ifconfig  # 需要安装net-tools，已停止维护
ip addr  # 需要安装iproute2，逐渐取代net-tools，推荐
```

返回字段解析

```shell
# 第一行
eth0: <BROADCAST,MULTICAST,UP,LOWER_UP>  # net_device flags(网络设备状态标识)
    # BROADCAST 表示这个网卡有广播地址，可以发送广播包
    # MULTICAST 表示网卡可以发送多播包
    # UP 表示网卡处于启动的状态
    # LOWER_UP 表示L1是启动的，也即网线插着呢
mtu 1500  # 最大传输单元1500字节(这是以太网的默认值)
    # MAC头后面的正文(包括IP头、TCP头、HTTP头)不允许超过1500个字节，存不下则分片传输
qdisc pfifo_fast  # queueing discipline(排队规则)
    # 内核通过某个网络接口发送数据包时，需要按照这个排队规则将数据包加入队列
state UP

# 第二行
link/ether 00:15:5d:21:b9:ea brd ff:ff:ff:ff:ff:ff  # mac地址

# 第三行
xxx.xx.xxx.x scope global eth0  # ethernet 以太网卡，范围global，对外访问
127.0.0.1/8 scope host lo  # loopback 环回接口，范围host，供本机相互通信
```

## 分配IP

设置项：IP、子网掩码、默认网关、DNS

方式

- Static(静态) IP

手工给设备设置IP地址

- Dynamic(动态) IP

设备向DHCP服务器（主机或路由器）发送一个请求，获取IP地址

> DHCP(Dynamic Host Configuration Protocol) 动态主机配置协议

分配地址的时候会设定租期，当租期过去50%时会向DHCP服务器发送续约请求，如果没有发则IP将被收回

此外，像打印机、服务器、路由器等这些IP不应该经常变化的设备，还可以在DHCP配置中根据MAC地址预留固定IP

## 数据链路层

也叫MAC层，Medium Access Control 媒体访问控制，主要解决多路访问时谁先发谁后发，以及发给谁等问题

当设备A想要与设备B通信，已知目标IP地址，还需要知道目标MAC地址才能通信

> MAC地址（因为属于MAC层，所以叫MAC地址），是网卡出厂自带的物理地址，类似于身份证号具有全球唯一标识性，仅用于子网内定位，互联网定位还得靠IP

首先设备A会查找交换机中的ARP cache(高速缓存表)，看是否缓存过设备B的MAC地址

> ARP(Address Resolution Protocol) 地址解析协议，用于将IP地址解析为MAC地址

如果缓存表为空，通过ARP向整个网络发送一个广播信息，询问每个设备谁有这个IP，以及MAC地址是啥，当目标IP收到消息后会返回自己的MAC地址，设备A收到MAC地址后缓存，下次就不需要再发送广播

```shell
# 查看缓存的MAC地址
arp -a  # windows
```

![20210728233712](https://i.loli.net/2021/07/28/LHSfZKazPWt7NmU.png)

动态的是通过广播获取然后缓存的，否则就是静态的，比如手动添加：`arp -s IP MAC`



局域网内通信时，只需要知道

## 域名

根域名，也叫Root/Apex/naked/bare Domains

## 参考

- 视频：[硬件茶谈](https://www.bilibili.com/video/BV1DD4y127r4)
- 文章：极客时间·[《趣谈网络协议》](https://time.geekbang.org/column/intro/100007101)
