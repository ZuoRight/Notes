# 用户认证

## 用户模型

可以使用内置的 User 模型，如果不符合需求可以自定义

`AbstractBaseUser` 提供了用户认证所必需的基本接口和字段，包括密码散列和令牌生成等。继承它允许你保留 Django 用户认证系统的基本功能，同时可以添加额外的字段和方法，以适应你的应用需求。与 并且可以与 Django 的其他部分（如中间件、视图和表单）保持兼容，这对于使用诸如用户权限、组和会话等 Django 内置功能至关重要。

当你只想添加额外的字段或改变某些属性时，继承 `AbstractUser` 可能是更好的选择，它是基于 `AbstractBaseUser` 的，已经包含了 Django 默认用户模型的所有字段和行为

```python
from django.contrib.auth.models import AbstractBaseUser

class MyUser(AbstractBaseUser):
    # 添加自定义字段
```

## 注册

- `forms.py`

```python
from django.contrib.auth.forms import UserCreationForm
from django.contrib.auth.models import User

class MyRegistrationForm(UserCreationForm):
    email = forms.EmailField(required=True)

    class Meta:
        model = User
        fields = ("username", "email", "password1", "password2")
```

- `views.py`

```python
from django.shortcuts import render, redirect
from .forms import MyRegistrationForm

def register(request):
    if request.method == 'POST':
        form = MyRegistrationForm(request.POST)
        if form.is_valid():
            user = form.save(commit=False)
            user.email = form.cleaned_data['email']
            user.save()
            # 这里可以添加用户登录逻辑，或者重定向到登录页面
            return redirect('login')  # 或重定向到其他页面
    else:
        form = MyRegistrationForm()
    return render(request, 'register.html', {'form': form})
```

- `urls.py`

```python
from django.urls import path
from .views import register

urlpatterns = [
    path('register/', register, name='register'),
    # 其他 URL 配置
]
```

- `templates/register.html`

```html
<form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Register</button>
</form>
```

## 登陆

- `forms.py`

```python
from django import forms
from django.contrib.auth.forms import AuthenticationForm

class MyLoginForm(AuthenticationForm):
    # 可以添加自定义字段或方法
```

- `views.py`

```python
from django.shortcuts import render, redirect
from django.contrib.auth import authenticate, login, logout

# 登入
def login_view(request):
    if request.method == 'POST':
        form = MyLoginForm(request, data=request.POST)
        if form.is_valid():
            username = form.cleaned_data.get('username')
            password = form.cleaned_data.get('password')
            user = authenticate(request, username=username, password=password)
            if user is not None:
                login(request, user)
                return redirect('home')  # 重定向到首页或其他页面
    else:
        form = MyLoginForm()
    return render(request, 'login.html', {'form': form})

# 登出
def logout_view(request):
    logout(request)
    return redirect('login')  # 重定向到登录页面或其他页面
```

- `urls.py`

```python
from django.urls import path
from .views import login_view

urlpatterns = [
    path('login/', login_view, name='login'),
    # 其他 URL 配置
]
```

- `templates/login.html`

```html
<form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Login</button>
</form>
```
