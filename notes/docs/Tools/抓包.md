# 抓包

CA：证书发行商

受信任的凭据，即证书
系统证书：系统内置的（需要有Root权限才能进行添加和删除）
用户证书：用户自行安装的

## 原理

1. 抓包工具先伪装成服务端接收客户端的请求
2. 然后再伪装成客户端将请求发送给真正的服务端


在三次握手阶段，应用的客户端一般会对服务端发来的公钥证书和私钥做验证，而服务端一般不会对客户端做验证。

抓包需要伪造公钥证书和私钥，工具内置了CA（证书发行商）证书，CA证书可以创建公钥证书和私钥，公钥证书可以在SSL/TLS握手的时候发送给客户端，客户端会对此证书进行验证，为了通过验证，我们需要将证书手动安装在系统中，作为真正的CA。

## Android

<https://juejin.im/post/6844903831579394055>

Android7.0+，`targetSdkVersion>=24`的应用不再信任用户证书，应对方式有4种

1. Root，将证书安装到系统证书目录

从抓包工具以系统证书格式（.0）导出证书，用MT管理器将证书复制或者通过adb remount然后push到/etc/security/cacerts/目录下（不要在sdcard中找这个目录直接拖拽过去）

2. AndroidManifest中配置networkSecurityConfig

<https://developer.android.com/training/articles/security-config>

3. 调低targetSdkVersion<24

GooglePlay限制targetSdkVersion必须>=28，国内应用市场也开始逐步响这种限制。绝大多数App的targetSdkVersion都将大于24了，也就意味着抓HTTPS的包越来越难操作了

4. 借助targetSdkVersion<24的宿主系统
  - 平行空间（v4.0.8625以下版本），HttpCanary设置中可以直接安装平行空间
  - VirtualApp

## 工具

Wireshark（前称Ethereal），Wireshark使用WinPCAP作为接口，直接与网卡进行数据报文交换

Fiddler

Charles

Tcpdump
[Trinea版本](http://www.trinea.cn/android/tcpdump_wireshark/)
[MrPeak版本](http://mrpeak.cn/blog/tutorial-tcpdump/)

安卓专用：
HttpCanary（v2.8.0前导出的证书名称不对，尽量用v2.8.0之后的版本）
Packet Caputure