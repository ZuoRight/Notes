# 网络层

判断目标地址是本地IP还是公网IP，如果是公网，则通过ARP协议（也就是已知IP地址，求MAC地址）获取网关MAC地址交给网关

> 操作系统启动的时候，DHCP协议会配置本机IP和默认网关的IP(192.168.1.1)

## IPv4

IPv4由32位二进制数组成，通常分割成4组，每组8位（以十进制数表示）

![20210725152948](http://image.zuoright.com/20210725152948.png)

IP组成：起始位+网络号+主机号，据此分成5类

![20210726230202](http://image.zuoright.com/20210726230202.png)

ABC类分别预留了三段IP用于不同规模组织作私有使用

D类为组播地址，向这个IP发送消息，组下的主机都可以收到

![20210725153815](http://image.zuoright.com/20210725153815.png)

但通常使用更灵活的CIDR(无类型域间选路)来表示，类似 `x.x.x.x/n` 这种形式，`/n`表示，前n位为固定的网络号，后(32-n)位为主机号

最常用的为`/24`和`/16`，比如最常见也最好理解的私有网络IP段：`192.168.1.x/24`，二进制为：`11000000.10101000.00000001.x`

前24位为网络号，后8位为主机号，网络号部分用1表示，主机号部分用0表示，即子网掩码：`11111111.11111111.11111111.00000000`，转换为10进制为：`255.255.255.0`

然后将二进制的IP和子网掩码按位逻辑与运算，即可得到网络地址：`11000000.10101000.00000001.00000000`，即：`192.168.1.0`

网络地址的主机号部分都置为1，则得到广播地址：`11000000.10101000.00000001.11111111`，即：`192.168.1.255`

- 192.168.1.x/24 IP
- 255.255.255.0 子网掩码
- 192.168.1.0 网络地址
- 192.168.1.255 广播地址（向这个地址发送消息所有主机都可以收到
- 192.168.1.1 第一个地址，通常为默认网关（路由器的一个网口）

除去网络地址和广播地址后，8位主机号可分配2^8=256-2=254个主机IP，还要预留一个给默认网关，知道了这个规则之后，便可以通过主机数倒推子网掩码来规划网络

比如有10台主机，则至少需要10+2+1=13个IP，因为2^4=16 > 13，所以主机号至少要4位，即子网掩码为：11111111.11111111.11111111.11110000，十进制为：255.255.255.240

随着互联网用户数以及联网应用/设备数的爆炸式增长，可用的大约36.47亿个IPv4地址已经无法满足地球约75亿人口所使用了，于是升级迭代出IPv6协议

> 2011年2月3日，IANA宣布IPv4地址已经耗尽

## IPv6

IPv6由128位二进制数组成，通常分割成8组，每组16位（以十六进制数表示）

可为地球的每一粒沙子提供唯一IP，但它与IPv4是两个完全不同的协议，需要转换和映射才能数据互通，完全取代IPv4可能还需要很长一段时间。

![20210725152103](http://image.zuoright.com/20210725152103.png)

## 查看IP

```shell
# windows
ipconfig /all

# linux/mac
ifconfig  # 需要安装net-tools，已停止维护
ip addr  # 需要安装iproute2，逐渐取代net-tools，推荐
```

返回字段解析

```shell
# 第一行
eth0: <BROADCAST,MULTICAST,UP,LOWER_UP>  # net_device flags(网络设备状态标识)
    # BROADCAST 表示这个网卡有广播地址，可以发送广播包
    # MULTICAST 表示网卡可以发送多播包
    # UP 表示网卡处于启动的状态
    # LOWER_UP 表示L1是启动的，也即网线插着呢
mtu 1500  # 最大传输单元1500字节(这是以太网的默认值)
    # MAC头后面的正文(包括IP头、TCP头、HTTP头)不允许超过1500个字节，存不下则分片传输
qdisc pfifo_fast  # queueing discipline(排队规则)
    # 内核通过某个网络接口发送数据包时，需要按照这个排队规则将数据包加入队列
state UP

# 第二行
link/ether 00:15:5d:21:b9:ea brd ff:ff:ff:ff:ff:ff  # mac地址

# 第三行
xxx.xx.xxx.x scope global eth0  # ethernet 以太网卡，范围global，对外访问
127.0.0.1/8 scope host lo  # loopback 环回接口，范围host，供本机相互通信
```

## 分配IP

设置项：IP、子网掩码、默认网关、DNS

方式

- Static(静态) IP

手工给设备设置IP地址

- Dynamic(动态) IP

设备向DHCP服务器（主机或路由器）发送一个请求，获取IP地址

> DHCP(Dynamic Host Configuration Protocol) 动态主机配置协议

分配地址的时候会设定租期，当租期过去50%时会向DHCP服务器发送续约请求，如果没有发则IP将被收回

此外，像打印机、服务器、路由器等这些IP不应该经常变化的设备，还可以在DHCP配置中根据MAC地址预留固定IP

## 特殊地址

- `0.0.0.0`

unspecified，未指定（即无效的，无意义的）地址

并不是一个真实的的IP地址，一般用于某些程序/网络协议中不便使用具体IP的特殊情况，表示本机中所有的IPv4地址

- `localhost`

不是IP，而是域名，用于指代 this host/computer，通常被指向IPV4的127.0.0.1和IPV6的::1

- `127.0.0.1`

凡是以127开头的地址，都属于回环地址(loop back address)，即发送给此地址的请求会被自己接收，外部设备无法访问

127.0.0.1只是回环地址中的一个，可用于测试网络是否正常：`ping 127.0.0.1`

> 如果遇到DDos攻击，可以将域名A记录解析到127.0.0.1，让其攻击自己

## 参考

[极客时间专栏：《趣谈网络协议》](https://time.geekbang.org/column/intro/100007101)
