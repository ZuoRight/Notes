# 链路层

当两台设备通信时，需要知道彼此的IP和MAC地址，根据IP段的网络地址是否相同，通信过程会有所不同

> MAC地址（属于MAC层所以叫MAC地址），是网卡出厂自带的物理地址，类似于身份证号具有全球唯一标识性，仅用于同网段局域网内定位，出了网关还得靠IP路由
>
> MAC(Medium Access Control) 媒体访问控制，主要解决多路访问时谁先发谁后发，以及发给谁等问题

网关（一般是路由器）通过路由协议（常用的有 OSPF 和 BGP）按路由表将数据包发出

## 网络地址相同

![20210729232611](http://image.zuoright.com/20210729232611.png)

设备A如果想要与同网段的设备B通信，首先，设备A先查找本机或交换机的ARP Cache中是否缓存过设备B的MAC地址

> ARP(Address Resolution Protocol) 地址解析协议，用于将IP地址解析为MAC地址

```shell
# 查看ARP Cache
arp -a  # windows

# 动态类型是通过广播获取然后缓存的
# 否则就是静态的，比如手动添加
arp -s IP MAC
```

![20210729233402](http://image.zuoright.com/20210729233402.png)

如果ARP Cache中没有，将向广播地址发起ARP请求，询问每个设备谁有这个IP，以及MAC地址是啥，当目标IP收到消息后会返回自己的MAC地址，设备A收到MAC地址后缓存到cache，下次可以直接发送不需要再广播

## 网络地址不同

![20210729232759](http://image.zuoright.com/20210729232759.png)

设备A如果想与跨网段的设备D通信，由于设备A和D的IP都是私有IP，彼此需要借助各自NAT网关的公有IP来通信

> NAT(Network Address Translation) 网关，主要工作就是将私有IP转换为公有IP
>
> 这只是因为IPv4提供的公有IP数不足，为了节约IP才创造出的一种协议，IPv6中是没必要存在的，但由于IPv6还未完全取代IPv4，两个协议混用转换时还是会用到NAT

![20210725151352](http://image.zuoright.com/20210725151352.png)

出了网关，通过动态路由表路由到目标设备

> BGP协议：基于TCP协议，根据距离矢量路由算法(Bellman-Ford)，找到最短路径，主要用于内网
>
> OSPF协议，基于IP协议，根据链路状态路由算法(Dijkstra)，找到最佳路径，主要用于外网
