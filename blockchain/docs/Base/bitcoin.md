# Bitcoin

比特币的区块链可以看作是运行在P2P网络中的公开账本，一笔笔交易存储在区块结构体中，然后被打包成一个区块，一个个区块按更新顺序串联成一条区块链，第一个区块被称之为创世区块。

打包区块的过程叫做工作量证明(POW)，因为可以从中获取奖励，所以俗称挖矿，由分布式网络中的节点来完成，俗称矿工。

> 区块奖励最初为50个BTC，每开采 210,000 个区块则会减半，2012年首次减半到25个，2016年减半到12.5个，2020年5月减半到了6.25个，平均每四年一次

![20220721193416](http://image.zuoright.com/20220721193416.png)

每个区块由区块头和区块体两部分组成

交易明细存储在区块体中，最大可存储1M，约4000条左右，交易是按顺序存放的，第一条交易是矿工写给自己的挖矿奖励，称作Coinbase交易，然后才是普通用户的交易，当然交易可以只有Coinbase(即空块)，但通常矿工不会这样做，因为打包其他交易还可以赚取手续费。

> 比特币诞生之初，单个区块大小的最高可以达到32M，但由于有人恶意制造的大量小额转账使网络中有大量的待确认交易，影响了网络运转，所以改为了1M

也就是说矿工每挖取并成功更新一个区块，获取的激励为：区块奖励+手续费，正因如此，才会有人愿意主动去做这件事，比特币网络才得以正常运行。

> 矿工在写奖励时不能乱写，否则会验证失败，白费精力
>
> 不过矿工可以优先选择打包手续费高的交易

但挖矿并没有那么容易，需要满足一定的条件

首先将每一笔交易哈希，然后每两个交易的哈希再哈希，依次递归，如果遇到奇数则使用自身的副本配对，最终会形成一颗倒立的哈希二叉树，其根哈希被称作默克尔根(Merkle)。

> 哈希二叉树，是一种用作快速归纳和校验大规模数据完整性的数据结构，在比特币网络中，可以通过默克尔树快速地校验某个交易是否存在于某个区块中。

默克尔根与父区块的哈希等组成区块头

- 父区块的哈希
- 默克尔根
- Nonce（随机数）
- 其它：区块高度、bits(难度系数)、时间戳等

![20220721173614](http://image.zuoright.com/20220721173614.png)

然后将区块头哈希，如果生成的哈希值小于某个目标值，便可以广播到区块链网络，反之则需要重新哈希。

目标值是基于难度系数根据公式动态算出来的，由256位二进制数组成，每一位不是0就是1，0的概率为1/2，要求小于目标值，实际就是要求前n位有多少个0，即概率为(1/2)的n次幂，理论上目标值越小则需要0越多，概率越低，挖矿的难度越大。

观察区块头可知，除了Nonce和时间戳外其它都是不能随意改变的，其中时间戳并不需要时时改变，只要大于上一个区块的时间戳并且在将来2小时以内即可。所以通常只能用穷举法不断地调换随机数来满足目标条件，这个过程便称之为工作量证明(Proof of Work)，简称POW。

> 不同矿工打包时的Coinbase交易收取地址不同，而且打包的交易也不一定相同，所以每个矿工要寻找的随机数也是不同的。

比特币网络的算力和难度一直呈上升趋势，目前全网算力大概200EH/s左右，而单机CPU算力不过几M，GPU算力也不过1G，所以单机挖矿的成功率几乎等于0，现在主要是专用的ASIC芯片构建的矿池挖矿。

> 算力：每秒产生哈希碰撞的能力，最小单位：H(Hash)，即1次运算  
> 1`E`=1000`P`=1000,000T=1000,000,000`G`=1000,000,000,000`K`=1000,000,000`G`=1000,000,000,000,000`H`

平均10分钟左右挖出一个区块，1小时就是6个，约每4年奖励减半一次，大致可以推算出比特币的总量约为2100万个，预计在2140年全部挖出。

> `6x24x365x4`x`50(1+1/2+1/4+1/8+...)`=`2100W`

## 隔离验证

## Difficulty Adjustment Period

为了保证生成一个区块的时间恒定，挖矿难度每过一个固定周期（2016个区块）就会调整一次。

计算一下上一个周期的平均耗时，理想时间为两周（1,209,600秒，平均10分钟一个区块），如果过快则会调高难度（调小目标值），反之调低。
